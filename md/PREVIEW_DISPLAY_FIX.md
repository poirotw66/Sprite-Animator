# Preview Display Fix - é è¦½é¡¯ç¤ºä¿®æ­£

## ðŸ› å•é¡Œæè¿° (Problem Description)

### ç¾è±¡
- **å‰ç«¯é è¦½**: äººç‰©çš„ä¸€äº›ç‰¹å¾µè‰²å½©(å¦‚ç²‰ç´…è‰²è¡£æœã€ç¶ è‰²é…ä»¶)æœƒè¢«èª¤åˆ¤ç‚ºèƒŒæ™¯è‰²,å°Žè‡´é¡¯ç¤ºç•°å¸¸
- **ä¸‹è¼‰çš„ PNG**: åŽ»èƒŒå®Œå…¨æ­£å¸¸,æ²’æœ‰å•é¡Œ

### æ ¹æœ¬åŽŸå› 
å•é¡Œå‡ºåœ¨ `utils/imageUtils.ts` ä¸­çš„ `isChromaKeyPixel()` å‡½æ•¸ã€‚é€™å€‹å‡½æ•¸ç”¨æ–¼**å…§å®¹åˆ†æž**(è¨ˆç®—é‚Šç•Œæ¡†å’Œä¸­å¿ƒé»ž),è€Œä¸æ˜¯å¯¦éš›çš„åŽ»èƒŒè™•ç†ã€‚

**å¯¦éš›åŽ»èƒŒ**æ˜¯åœ¨ `workers/chromaKeyWorker.ts` ä¸­å®Œæˆçš„,æ‰€ä»¥ä¸‹è¼‰çš„ PNG æ˜¯æ­£å¸¸çš„ã€‚

**å‰ç«¯é¡¯ç¤ºå•é¡Œ**æ˜¯å› ç‚º `isChromaKeyPixel()` çš„æª¢æ¸¬é‚è¼¯å¤ªå¯¬é¬†,å°Žè‡´:
1. äººç‰©çš„ç²‰ç´…è‰²/ç¶ è‰²è¢«èª¤åˆ¤ç‚ºèƒŒæ™¯è‰²
2. é‚Šç•Œæ¡†è¨ˆç®—éŒ¯èª¤
3. ä¸­å¿ƒé»žè¨ˆç®—éŒ¯èª¤
4. é¡¯ç¤ºæ™‚äººç‰©è¢«éŒ¯èª¤è£å‰ªæˆ–ä½ç½®åç§»

## âœ… è§£æ±ºæ–¹æ¡ˆ (Solution)

### ä¿®æ­£ `isChromaKeyPixel()` å‡½æ•¸

**æª”æ¡ˆ**: `utils/imageUtils.ts`

#### ä¹‹å‰çš„é‚è¼¯ (å¤ªå¯¬é¬†)
```typescript
const isMagentaLike = (r > 180 && g < 100 && b > 100) ||
  (r > 150 && g < 80 && b > 150) ||
  (r > 200 && g < 50 && b > 200);
const isGreenLike = (g > 180 && r < 100 && b < 100) ||
  (g > 150 && r < 80 && b < 80);
```

**å•é¡Œ**: 
- ç²‰ç´…è‰²è¡£æœ (ä¾‹å¦‚ R=200, G=80, B=150) æœƒè¢«èª¤åˆ¤ç‚ºæ´‹ç´…è‰²
- ç¶ è‰²é…ä»¶ (ä¾‹å¦‚ G=180, R=50, B=50) æœƒè¢«èª¤åˆ¤ç‚ºç¶ å¹•

#### ä¿®æ­£å¾Œçš„é‚è¼¯ (åš´æ ¼)
```typescript
// Pure magenta chroma key (#FF00FF): R=255, G=0, B=255
// Only match if it's VERY close to pure magenta
const isPureMagenta = r > 240 && g < 30 && b > 240 && Math.abs(r - b) < 20;

// Standard green screen (#00B140): R=0, G=177, B=64
// Only match if it's VERY close to standard green screen
const isStandardGreen = g > 150 && g < 200 && r < 30 && b < 100 && 
  (g - r) > 120 && (g - b) > 50;

// Pure bright green (#00FF00): R=0, G=255, B=0
const isPureGreen = g > 240 && r < 30 && b < 30;
```

**æ”¹é€²**:
- âœ… åªåŒ¹é…**éžå¸¸æŽ¥è¿‘**ç´”è‰²åº¦åŽ»èƒŒè‰²çš„åƒç´ 
- âœ… ç²‰ç´…è‰²è¡£æœä¸æœƒè¢«èª¤åˆ¤ (éœ€è¦ R>240, G<30, B>240)
- âœ… ç¶ è‰²é…ä»¶ä¸æœƒè¢«èª¤åˆ¤ (éœ€è¦ G>150, R<30, B<100, ä¸” G-R>120)
- âœ… å¢žåŠ  `Math.abs(r - b) < 20` ç¢ºä¿æ´‹ç´…è‰²æ˜¯ç´”è‰²

## ðŸ“Š æª¢æ¸¬ç¯„åœå°æ¯”

### æ´‹ç´…è‰²æª¢æ¸¬

| é¡è‰²ç¯„ä¾‹ | RGB | ä¹‹å‰ | ä¹‹å¾Œ | èªªæ˜Ž |
|---------|-----|------|------|------|
| #FF00FF (ç´”æ´‹ç´…) | (255, 0, 255) | âœ… | âœ… | ç›®æ¨™è‰² |
| #FE00FE | (254, 0, 254) | âœ… | âœ… | éžå¸¸æŽ¥è¿‘ |
| #C800C8 (æ·±æ´‹ç´…) | (200, 0, 200) | âœ… | âŒ | å¤ªæš—,ä¸åŒ¹é… |
| #FF80FF (æ·ºç²‰ç´…) | (255, 128, 255) | âœ… | âŒ | Gå¤ªé«˜,ä¸åŒ¹é… |
| #FF50C8 (ç²‰ç´…) | (255, 80, 200) | âœ… | âŒ | ä¸æ˜¯ç´”æ´‹ç´… |
| ç²‰ç´…è‰²è¡£æœ | (200, 80, 150) | âœ… | âŒ | **ä¿®æ­£å‰èª¤åˆ¤** |

### ç¶ è‰²æª¢æ¸¬

| é¡è‰²ç¯„ä¾‹ | RGB | ä¹‹å‰ | ä¹‹å¾Œ | èªªæ˜Ž |
|---------|-----|------|------|------|
| #00B140 (æ¨™æº–ç¶ å¹•) | (0, 177, 64) | âœ… | âœ… | ç›®æ¨™è‰² |
| #00FF00 (ç´”ç¶ ) | (0, 255, 0) | âœ… | âœ… | ç´”ç¶ è‰² |
| #00C850 | (0, 200, 80) | âœ… | âœ… | æŽ¥è¿‘æ¨™æº– |
| #80FF80 (æ·ºç¶ ) | (128, 255, 128) | âœ… | âŒ | Rå¤ªé«˜,ä¸åŒ¹é… |
| #50C850 (è‰ç¶ ) | (80, 200, 80) | âœ… | âŒ | Rå¤ªé«˜,ä¸åŒ¹é… |
| ç¶ è‰²é…ä»¶ | (50, 180, 50) | âœ… | âŒ | **ä¿®æ­£å‰èª¤åˆ¤** |

## ðŸŽ¯ å½±éŸ¿ç¯„åœ (Impact)

### ä¿®æ­£å‰
- âŒ ç²‰ç´…è‰²/ç´«è‰²è¡£æœè¢«èª¤åˆ¤ç‚ºèƒŒæ™¯
- âŒ ç¶ è‰²é…ä»¶/è£é£¾è¢«èª¤åˆ¤ç‚ºèƒŒæ™¯
- âŒ é‚Šç•Œæ¡†è¨ˆç®—éŒ¯èª¤
- âŒ ä¸­å¿ƒé»žè¨ˆç®—éŒ¯èª¤
- âŒ é¡¯ç¤ºæ™‚äººç‰©è¢«éŒ¯èª¤è£å‰ª

### ä¿®æ­£å¾Œ
- âœ… åªåŒ¹é…çœŸæ­£çš„è‰²åº¦åŽ»èƒŒè‰²
- âœ… äººç‰©é¡è‰²ä¸æœƒè¢«èª¤åˆ¤
- âœ… é‚Šç•Œæ¡†è¨ˆç®—æ­£ç¢º
- âœ… ä¸­å¿ƒé»žè¨ˆç®—æ­£ç¢º
- âœ… é¡¯ç¤ºæ­£å¸¸

## ðŸ” æŠ€è¡“ç´°ç¯€ (Technical Details)

### `isChromaKeyPixel()` çš„ç”¨é€”

é€™å€‹å‡½æ•¸**åªç”¨æ–¼å…§å®¹åˆ†æž**,åœ¨ `analyzeFrameContent()` å‡½æ•¸ä¸­:

1. **è¨ˆç®—é‚Šç•Œæ¡†** (Bounding Box)
   - æ‰¾å‡ºäººç‰©çš„æœ€å°/æœ€å¤§ X/Y åº§æ¨™
   - ç”¨æ–¼è‡ªå‹•è£å‰ªå’Œå®šä½

2. **è¨ˆç®—ä¸­å¿ƒé»ž** (Center of Mass)
   - è¨ˆç®—äººç‰©çš„é‡å¿ƒä½ç½®
   - ç”¨æ–¼å°é½Šå’Œå±…ä¸­

3. **è¨ˆç®—æ ¸å¿ƒå€åŸŸ** (Core Region)
   - åˆ†æžè»€å¹¹å€åŸŸ(æ›´ç©©å®š)
   - ç”¨æ–¼æ›´ç²¾ç¢ºçš„å®šä½

### ç‚ºä»€éº¼ä¸å½±éŸ¿ä¸‹è¼‰çš„ PNG?

å› ç‚º**å¯¦éš›çš„åŽ»èƒŒè™•ç†**æ˜¯åœ¨ `workers/chromaKeyWorker.ts` ä¸­å®Œæˆçš„,ä½¿ç”¨å®Œå…¨ä¸åŒçš„ã€æ›´ç²¾ç¢ºçš„ç®—æ³•ã€‚`isChromaKeyPixel()` åªå½±éŸ¿å‰ç«¯é¡¯ç¤ºæ™‚çš„å…§å®¹åˆ†æžã€‚

## ðŸ“ ä¿®æ”¹çš„æª”æ¡ˆ (Modified Files)

- âœ… `utils/imageUtils.ts`
  - ä¿®æ­£ `isChromaKeyPixel()` å‡½æ•¸
  - ä½¿æª¢æ¸¬é‚è¼¯æ›´åš´æ ¼,é¿å…èª¤åˆ¤

## ðŸ§ª æ¸¬è©¦å»ºè­° (Testing Recommendations)

### æ¸¬è©¦æ¡ˆä¾‹ 1: ç²‰ç´…è‰²è¡£æœ
```
1. ç”Ÿæˆå¸¶æœ‰ç²‰ç´…è‰²è¡£æœè§’è‰²çš„ç²¾éˆåœ–
2. ä½¿ç”¨æ´‹ç´…è‰²èƒŒæ™¯
3. æª¢æŸ¥å‰ç«¯é è¦½æ˜¯å¦æ­£å¸¸
4. æª¢æŸ¥é‚Šç•Œæ¡†æ˜¯å¦æ­£ç¢º
5. ä¸‹è¼‰ PNG ç¢ºèªåŽ»èƒŒæ­£å¸¸
```

### æ¸¬è©¦æ¡ˆä¾‹ 2: ç¶ è‰²é…ä»¶
```
1. ç”Ÿæˆå¸¶æœ‰ç¶ è‰²é…ä»¶è§’è‰²çš„ç²¾éˆåœ–
2. ä½¿ç”¨ç¶ å¹•èƒŒæ™¯
3. æª¢æŸ¥å‰ç«¯é è¦½æ˜¯å¦æ­£å¸¸
4. æª¢æŸ¥é‚Šç•Œæ¡†æ˜¯å¦æ­£ç¢º
5. ä¸‹è¼‰ PNG ç¢ºèªåŽ»èƒŒæ­£å¸¸
```

### æ¸¬è©¦æ¡ˆä¾‹ 3: æ··åˆé¡è‰²
```
1. ç”Ÿæˆå¸¶æœ‰ç²‰ç´…è‰²å’Œç¶ è‰²å…ƒç´ çš„è§’è‰²
2. åˆ†åˆ¥æ¸¬è©¦æ´‹ç´…è‰²å’Œç¶ å¹•èƒŒæ™¯
3. ç¢ºèªå…©ç¨®æƒ…æ³ä¸‹éƒ½æ­£å¸¸
```

## âš ï¸ æ³¨æ„äº‹é … (Notes)

### é€™å€‹å‡½æ•¸çš„è¨­è¨ˆåŽŸå‰‡

1. **åªåŒ¹é…çœŸæ­£çš„è‰²åº¦åŽ»èƒŒè‰²**
   - å¿…é ˆéžå¸¸æŽ¥è¿‘ç´”è‰² (#FF00FF æˆ– #00B140)
   - ä¸æ‡‰è©²åŒ¹é…äººç‰©çš„ä»»ä½•é¡è‰²

2. **å¯§å¯æ¼åˆ¤,ä¸å¯èª¤åˆ¤**
   - å¦‚æžœé‚Šç•Œæ¡†ç¨å¾®å¤§ä¸€é»ž(åŒ…å«ä¸€äº›èƒŒæ™¯),æ²’é—œä¿‚
   - ä½†å¦‚æžœèª¤åˆ¤äººç‰©é¡è‰²,æœƒå°Žè‡´åš´é‡å•é¡Œ

3. **åªå½±éŸ¿é¡¯ç¤º,ä¸å½±éŸ¿åŽ»èƒŒ**
   - å¯¦éš›çš„åŽ»èƒŒç”± Worker å®Œæˆ
   - é€™å€‹å‡½æ•¸åªå½±éŸ¿å…§å®¹åˆ†æž

## ðŸŽ‰ ç¸½çµ (Summary)

**å•é¡Œ**: å‰ç«¯é è¦½æ™‚äººç‰©é¡è‰²è¢«èª¤åˆ¤ç‚ºèƒŒæ™¯è‰²  
**åŽŸå› **: `isChromaKeyPixel()` æª¢æ¸¬é‚è¼¯å¤ªå¯¬é¬†  
**è§£æ±º**: ä½¿æª¢æ¸¬æ›´åš´æ ¼,åªåŒ¹é…çœŸæ­£çš„è‰²åº¦åŽ»èƒŒè‰²  
**çµæžœ**: å‰ç«¯é¡¯ç¤ºæ­£å¸¸,ä¸‹è¼‰çš„ PNG ä¾ç„¶æ­£å¸¸  

**ç‹€æ…‹**: âœ… å·²ä¿®æ­£

---

**ç‰ˆæœ¬**: v2.1.0  
**æ—¥æœŸ**: 2026-01-30  
**ç›¸é—œ**: [Chroma Key Improvements v2.0](./CHROMA_KEY_IMPROVEMENTS_V2.md)
